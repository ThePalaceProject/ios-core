name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  unit-tests:
    name: Run Tests
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.0.app || sudo xcode-select -s /Applications/Xcode_15.4.app
      
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      
      - name: Run Tests
        run: |
          xcodebuild test \
            -project Palace.xcodeproj \
            -scheme Palace \
            -destination 'platform=iOS Simulator,name=iPhone 15,arch=x86_64' \
            -resultBundlePath TestResults.xcresult \
            -enableCodeCoverage YES \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee build.log | xcpretty --report junit --output test-results.xml || true
      
      - name: Generate Test Report
        if: always()
        run: |
          # Install xcparse for extracting results
          brew install chargepoint/xcparse/xcparse || true
          
          # Extract test results
          if [ -d "TestResults.xcresult" ]; then
            # Extract screenshots from failed tests
            xcparse screenshots TestResults.xcresult ./test-screenshots --legacy || true
            
            # Generate summary
            xcrun xcresulttool get --path TestResults.xcresult --format json > results.json 2>/dev/null || true
          fi
      
      - name: Parse and Display Results
        if: always()
        run: |
          # Create summary for GitHub
          echo "## üìä Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count tests from log
          PASSED=$(grep -c "Test Case.*passed" build.log 2>/dev/null || echo "0")
          FAILED=$(grep -c "Test Case.*failed" build.log 2>/dev/null || echo "0")
          TOTAL=$((PASSED + FAILED))
          
          if [ "$FAILED" -eq "0" ]; then
            echo "### ‚úÖ All Tests Passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Some Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| üìù Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List failed tests
          if [ "$FAILED" -gt "0" ]; then
            echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep "Test Case.*failed" build.log | sed 's/.*Test Case/Test Case/' | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            TestResults.xcresult
            test-results.xml
            build.log
          retention-days: 14
      
      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-screenshots
          path: test-screenshots/
          retention-days: 14
          if-no-files-found: ignore
      
      - name: Upload Snapshot Diffs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: snapshot-failures
          path: |
            PalaceTests/**/__Snapshots__/**/*.png
            PalaceTests/**/Failures/**/*.png
          retention-days: 14
          if-no-files-found: ignore
      
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: 'test-results.xml'
          fail_on_failure: false
          include_passed: true
          detailed_summary: true

  # Optional: Post snapshots to PR as comment
  post-snapshots:
    name: Post Snapshot Preview
    runs-on: ubuntu-latest
    needs: unit-tests
    if: failure() && github.event_name == 'pull_request'
    
    steps:
      - name: Download Snapshots
        uses: actions/download-artifact@v4
        with:
          name: snapshot-failures
          path: snapshots
        continue-on-error: true
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let body = '## üì∏ Snapshot Test Failures\n\n';
            body += 'Some snapshot tests failed. ';
            body += 'Download the `snapshot-failures` artifact to see the differences.\n\n';
            body += '| Test | Status |\n|------|--------|\n';
            
            // List snapshot files if available
            try {
              const files = fs.readdirSync('snapshots', { recursive: true });
              files.filter(f => f.endsWith('.png')).slice(0, 10).forEach(f => {
                body += `| ${f} | ‚ùå |\n`;
              });
            } catch (e) {
              body += '| No snapshots found | - |\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

