name: Unit Tests
on: [ pull_request, workflow_dispatch ]
jobs:
  build-and-test:
    runs-on: macos-14
    steps:
      - name: Set up Xcode 16.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Verify Xcode Version
        run: xcodebuild -version
        
      - name: Checkout main repo and submodules
        uses: actions/checkout@v3
        with:
          submodules: true
          token: ${{ secrets.CI_GITHUB_ACCESS_TOKEN }}
          
      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            .build
            SourcePackages
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
            
      - name: Cache Xcode DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-
            
      - name: Checkout Certificates
        uses: actions/checkout@v3
        with:
          repository: ThePalaceProject/mobile-certificates
          token: ${{ secrets.CI_GITHUB_ACCESS_TOKEN }}
          path: ./mobile-certificates
          
      - name: Checkout Adobe RMSDK
        uses: ./.github/actions/checkout-adobe
        with:
          token: ${{ secrets.CI_GITHUB_ACCESS_TOKEN }}
          
      - name: Setup repo with DRM
        run: ./scripts/setup-repo-drm.sh
        env:
          BUILD_CONTEXT: ci
          
      - name: Build non-Carthage 3rd party dependencies
        run: ./scripts/build-3rd-party-dependencies.sh
        env:
          BUILD_CONTEXT: ci
          
      - name: List available simulators for debugging
        run: xcrun simctl list devices available | grep iPhone | head -10
        
      - name: Run Palace unit tests
        id: tests
        run: ./scripts/xcode-test-optimized.sh
        env:
          BUILD_CONTEXT: ci
        continue-on-error: true
          
      - name: Parse Test Results
        if: always()
        id: parse
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "TestResults.xcresult" ]; then
            # Get test counts from xcresulttool
            RESULT_JSON=$(xcrun xcresulttool get --path TestResults.xcresult --format json 2>/dev/null || echo "{}")
            
            TESTS=$(echo "$RESULT_JSON" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('metrics',{}).get('testsCount',{}).get('_value','0'))" 2>/dev/null || echo "0")
            FAILURES=$(echo "$RESULT_JSON" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('metrics',{}).get('testsFailedCount',{}).get('_value','0'))" 2>/dev/null || echo "0")
            
            if [ "$TESTS" != "0" ]; then
              PASSED=$((TESTS - FAILURES))
              if [ "$FAILURES" = "0" ]; then
                echo "âœ… **$PASSED passed** out of **$TESTS tests**" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ **$PASSED passed**, **$FAILURES failed** out of **$TESTS tests**" >> $GITHUB_STEP_SUMMARY
              fi
              echo "tests=$TESTS" >> $GITHUB_OUTPUT
              echo "failures=$FAILURES" >> $GITHUB_OUTPUT
            else
              # Fallback: check if tests ran by looking at result bundle size
              SIZE=$(du -sh TestResults.xcresult 2>/dev/null | cut -f1 || echo "0")
              echo "âœ… Tests completed (result bundle: $SIZE)" >> $GITHUB_STEP_SUMMARY
              echo "tests=unknown" >> $GITHUB_OUTPUT
              echo "failures=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ No test results found (TestResults.xcresult missing)" >> $GITHUB_STEP_SUMMARY
            echo "tests=0" >> $GITHUB_OUTPUT
            echo "failures=0" >> $GITHUB_OUTPUT
          fi
          
      - name: Check for Snapshot Failures
        if: always()
        id: snapshots
        run: |
          # Find snapshot failure images
          mkdir -p snapshot-failures
          FOUND=0
          
          # Check simulator temp directories
          find /Users/runner/Library/Developer/CoreSimulator -name "*.png" -path "*tmp*" 2>/dev/null | while read -r file; do
            cp "$file" snapshot-failures/ 2>/dev/null && FOUND=1
          done
          
          # Check common failure directories  
          find . -path "*/__Snapshots__/*" -name "*.png" -newer TestResults.xcresult 2>/dev/null | head -20 | while read -r file; do
            cp "$file" snapshot-failures/ 2>/dev/null
          done
          
          COUNT=$(ls -1 snapshot-failures/*.png 2>/dev/null | wc -l | tr -d ' ')
          
          if [ "$COUNT" -gt "0" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "count=$COUNT" >> $GITHUB_OUTPUT
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¸ Snapshot Failures ($COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Failed snapshots detected. Download the **snapshot-failures** artifact below to view diffs." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            ls -1 snapshot-failures/*.png 2>/dev/null | head -10 | while read -r f; do
              echo "- \`$(basename "$f")\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload Snapshot Failures
        if: steps.snapshots.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-failures
          path: snapshot-failures/
          retention-days: 3
          if-no-files-found: ignore
          
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults.xcresult
          retention-days: 3
          if-no-files-found: ignore
          
      - name: Add Artifact Links
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download from the **Artifacts** section at the bottom of this page:" >> $GITHUB_STEP_SUMMARY
          echo "- **test-results** - Full Xcode test results (.xcresult)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.snapshots.outputs.found }}" = "true" ]; then
            echo "- **snapshot-failures** - Failed snapshot diff images" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Fail if tests failed
        if: steps.tests.outcome == 'failure'
        run: exit 1
