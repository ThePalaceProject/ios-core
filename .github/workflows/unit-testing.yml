name: Unit Tests
on: [ pull_request, workflow_dispatch ]
jobs:
  build-and-test:
    runs-on: macos-14
    steps:
      - name: Set up Xcode 16.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Verify Xcode Version
        run: xcodebuild -version
        
      - name: Checkout main repo and submodules
        uses: actions/checkout@v3
        with:
          submodules: true
          token: ${{ secrets.CI_GITHUB_ACCESS_TOKEN }}
          
      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            .build
            SourcePackages
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
            
      - name: Cache Xcode DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-
            
      - name: Checkout Certificates
        uses: actions/checkout@v3
        with:
          repository: ThePalaceProject/mobile-certificates
          token: ${{ secrets.CI_GITHUB_ACCESS_TOKEN }}
          path: ./mobile-certificates
          
      - name: Checkout Adobe RMSDK
        uses: ./.github/actions/checkout-adobe
        with:
          token: ${{ secrets.CI_GITHUB_ACCESS_TOKEN }}
          
      - name: Setup repo with DRM
        run: ./scripts/setup-repo-drm.sh
        env:
          BUILD_CONTEXT: ci
          
      - name: Build non-Carthage 3rd party dependencies
        run: ./scripts/build-3rd-party-dependencies.sh
        env:
          BUILD_CONTEXT: ci
          
      - name: List available simulators for debugging
        run: xcrun simctl list devices available | grep iPhone | head -10
        
      - name: Run Palace unit tests
        id: tests
        run: ./scripts/xcode-test-optimized.sh
        env:
          BUILD_CONTEXT: ci
        continue-on-error: true
          
      - name: Find and Process Test Results
        if: always()
        id: results
        run: |
          # Find xcresult
          RESULT_PATH=""
          if [ -d "TestResults.xcresult" ]; then
            RESULT_PATH="TestResults.xcresult"
          else
            RESULT_PATH=$(find . -name "*.xcresult" -type d 2>/dev/null | head -1)
          fi
          
          if [ -z "$RESULT_PATH" ]; then
            RESULT_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "*.xcresult" -type d -mmin -30 2>/dev/null | head -1)
            if [ -n "$RESULT_PATH" ]; then
              cp -r "$RESULT_PATH" ./TestResults.xcresult
              RESULT_PATH="TestResults.xcresult"
            fi
          fi
          
          mkdir -p test-report
          
          if [ -n "$RESULT_PATH" ] && [ -d "$RESULT_PATH" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "path=$RESULT_PATH" >> $GITHUB_OUTPUT
            
            # Extract human-readable summary
            echo "# Test Results Summary" > test-report/summary.txt
            echo "Generated: $(date)" >> test-report/summary.txt
            echo "" >> test-report/summary.txt
            
            # Get metrics
            RESULT_JSON=$(xcrun xcresulttool get --path "$RESULT_PATH" --format json 2>/dev/null || echo "{}")
            TESTS=$(echo "$RESULT_JSON" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('metrics',{}).get('testsCount',{}).get('_value','0'))" 2>/dev/null || echo "0")
            FAILURES=$(echo "$RESULT_JSON" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('metrics',{}).get('testsFailedCount',{}).get('_value','0'))" 2>/dev/null || echo "0")
            
            echo "tests=$TESTS" >> $GITHUB_OUTPUT
            echo "failures=$FAILURES" >> $GITHUB_OUTPUT
            
            if [ "$TESTS" != "0" ] && [ "$TESTS" != "" ]; then
              PASSED=$((TESTS - FAILURES))
              echo "Total Tests: $TESTS" >> test-report/summary.txt
              echo "Passed: $PASSED" >> test-report/summary.txt
              echo "Failed: $FAILURES" >> test-report/summary.txt
            fi
            
            echo "" >> test-report/summary.txt
            echo "## Failed Tests" >> test-report/summary.txt
            
            # Extract failed test names
            xcrun xcresulttool get --path "$RESULT_PATH" --format json 2>/dev/null | \
              python3 -c "
          import json, sys
          try:
              data = json.load(sys.stdin)
              actions = data.get('actions', {}).get('_values', [])
              for action in actions:
                  result = action.get('actionResult', {})
                  issues = result.get('issues', {})
                  test_failures = issues.get('testFailureSummaries', {}).get('_values', [])
                  for failure in test_failures:
                      name = failure.get('testCaseName', {}).get('_value', 'Unknown')
                      msg = failure.get('message', {}).get('_value', '')
                      print(f'âŒ {name}')
                      if msg:
                          print(f'   {msg[:100]}')
          except:
              pass
          " >> test-report/summary.txt 2>/dev/null || echo "Could not extract failure details" >> test-report/summary.txt
            
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "tests=0" >> $GITHUB_OUTPUT
            echo "failures=0" >> $GITHUB_OUTPUT
            echo "No xcresult bundle found" > test-report/summary.txt
          fi
          
      - name: Generate GitHub Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TESTS="${{ steps.results.outputs.tests }}"
          FAILURES="${{ steps.results.outputs.failures }}"
          
          if [ "$TESTS" != "0" ] && [ "$TESTS" != "" ]; then
            PASSED=$((TESTS - FAILURES))
            if [ "$FAILURES" = "0" ]; then
              echo "âœ… **$PASSED passed** out of **$TESTS tests**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **$PASSED passed**, **$FAILURES failed** out of **$TESTS tests**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            if [ "${{ steps.tests.outcome }}" = "success" ]; then
              echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Tests failed - check logs for details" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Show failed tests if any
          if [ -f "test-report/summary.txt" ]; then
            FAILED_TESTS=$(grep "^âŒ" test-report/summary.txt 2>/dev/null | head -10)
            if [ -n "$FAILED_TESTS" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
      - name: Collect Snapshot Failures
        if: failure() || steps.tests.outcome == 'failure'
        id: snapshots
        run: |
          mkdir -p test-report/snapshots
          
          # Find and copy snapshot failures
          find /Users/runner/Library/Developer/CoreSimulator -name "*.png" -path "*tmp*" 2>/dev/null | while read -r file; do
            cp "$file" test-report/snapshots/ 2>/dev/null || true
          done
          
          COUNT=$(ls -1 test-report/snapshots/*.png 2>/dev/null | wc -l | tr -d ' ')
          
          if [ "$COUNT" -gt "0" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¸ Snapshot Failures ($COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download **test-report** artifact to view diff images." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            ls -1 test-report/snapshots/*.png 2>/dev/null | head -10 | while read -r f; do
              echo "- \`$(basename "$f")\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-report/
          retention-days: 3
          if-no-files-found: ignore
          
      - name: Finish Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Download **test-report** artifact for details (summary.txt + snapshot diffs)" >> $GITHUB_STEP_SUMMARY
          
      - name: Fail if tests failed
        if: steps.tests.outcome == 'failure'
        run: exit 1
