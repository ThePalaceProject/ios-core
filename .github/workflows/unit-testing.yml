name: Unit Tests
on: [ pull_request, workflow_dispatch ]
jobs:
  build-and-test:
    runs-on: macos-14
    steps:
      - name: Set up Xcode 16.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Verify Xcode Version
        run: xcodebuild -version
        
      - name: Checkout main repo and submodules
        uses: actions/checkout@v3
        with:
          submodules: true
          token: ${{ secrets.CI_GITHUB_ACCESS_TOKEN }}
          
      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            .build
            SourcePackages
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
            
      - name: Cache Xcode DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-
            
      - name: Checkout Certificates
        uses: actions/checkout@v3
        with:
          repository: ThePalaceProject/mobile-certificates
          token: ${{ secrets.CI_GITHUB_ACCESS_TOKEN }}
          path: ./mobile-certificates
          
      - name: Checkout Adobe RMSDK
        uses: ./.github/actions/checkout-adobe
        with:
          token: ${{ secrets.CI_GITHUB_ACCESS_TOKEN }}
          
      - name: Setup repo with DRM
        run: ./scripts/setup-repo-drm.sh
        env:
          BUILD_CONTEXT: ci
          
      - name: Build non-Carthage 3rd party dependencies
        run: ./scripts/build-3rd-party-dependencies.sh
        env:
          BUILD_CONTEXT: ci
          
      - name: List available simulators for debugging
        run: xcrun simctl list devices available | grep iPhone | head -10
        
      - name: Run Palace unit tests
        id: tests
        run: ./scripts/xcode-test-optimized.sh
        env:
          BUILD_CONTEXT: ci
        continue-on-error: true
          
      - name: Find Test Results
        if: always()
        id: find_results
        run: |
          echo "Looking for xcresult bundles..."
          
          # Check current directory
          if [ -d "TestResults.xcresult" ]; then
            echo "Found: ./TestResults.xcresult"
            echo "path=TestResults.xcresult" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Search in common locations
          FOUND=$(find . -name "*.xcresult" -type d 2>/dev/null | head -1)
          if [ -n "$FOUND" ]; then
            echo "Found: $FOUND"
            echo "path=$FOUND" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Search in DerivedData
          FOUND=$(find ~/Library/Developer/Xcode/DerivedData -name "*.xcresult" -type d 2>/dev/null | head -1)
          if [ -n "$FOUND" ]; then
            echo "Found in DerivedData: $FOUND"
            cp -r "$FOUND" ./TestResults.xcresult
            echo "path=TestResults.xcresult" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "No xcresult found"
          echo "found=false" >> $GITHUB_OUTPUT
          
      - name: Generate Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          RESULT_PATH="${{ steps.find_results.outputs.path }}"
          
          if [ "${{ steps.find_results.outputs.found }}" = "true" ] && [ -d "$RESULT_PATH" ]; then
            # Get test counts
            RESULT_JSON=$(xcrun xcresulttool get --path "$RESULT_PATH" --format json 2>/dev/null || echo "{}")
            
            TESTS=$(echo "$RESULT_JSON" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('metrics',{}).get('testsCount',{}).get('_value','0'))" 2>/dev/null || echo "0")
            FAILURES=$(echo "$RESULT_JSON" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('metrics',{}).get('testsFailedCount',{}).get('_value','0'))" 2>/dev/null || echo "0")
            
            if [ "$TESTS" != "0" ] && [ "$TESTS" != "" ]; then
              PASSED=$((TESTS - FAILURES))
              if [ "$FAILURES" = "0" ]; then
                echo "âœ… **$PASSED passed** out of **$TESTS tests**" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ **$PASSED passed**, **$FAILURES failed** out of **$TESTS tests**" >> $GITHUB_STEP_SUMMARY
              fi
            else
              # Fallback: show that tests ran
              SIZE=$(du -sh "$RESULT_PATH" 2>/dev/null | cut -f1 || echo "unknown")
              if [ "${{ steps.tests.outcome }}" = "success" ]; then
                echo "âœ… All tests passed (result bundle: $SIZE)" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Some tests failed (result bundle: $SIZE)" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            # No xcresult - use test step outcome
            if [ "${{ steps.tests.outcome }}" = "success" ]; then
              echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Tests failed - check logs for details" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
      - name: Collect Snapshot Failures
        if: always()
        id: snapshots
        run: |
          mkdir -p snapshot-failures
          
          echo "Searching for snapshot failures..."
          
          # Search in multiple locations where SnapshotTesting puts failure images
          
          # 1. Simulator temp directories (where SnapshotTesting writes new snapshots)
          echo "Checking simulator temp directories..."
          find /Users/runner/Library/Developer/CoreSimulator -name "*.png" -path "*tmp*" -type f 2>/dev/null | while read -r file; do
            echo "Found: $file"
            cp "$file" snapshot-failures/ 2>/dev/null || true
          done
          
          # 2. App container tmp directories
          echo "Checking app containers..."
          find /Users/runner/Library/Developer/CoreSimulator/Devices -path "*/tmp/*.png" -type f 2>/dev/null | while read -r file; do
            echo "Found: $file"
            cp "$file" snapshot-failures/ 2>/dev/null || true
          done
          
          # 3. Any Failures directories in DerivedData
          echo "Checking DerivedData..."
          find ~/Library/Developer/Xcode/DerivedData -name "*.png" -path "*Failures*" -type f 2>/dev/null | while read -r file; do
            echo "Found: $file"
            cp "$file" snapshot-failures/ 2>/dev/null || true
          done
          
          # 4. Check workspace for any snapshot test output
          echo "Checking workspace..."
          find . -name "*.png" -path "*tmp*" -type f 2>/dev/null | while read -r file; do
            echo "Found: $file"
            cp "$file" snapshot-failures/ 2>/dev/null || true
          done
          
          # 5. Check for __Snapshots__ directories with recent modifications
          echo "Checking for recent snapshot changes..."
          if [ -d "TestResults.xcresult" ]; then
            find . -path "*__Snapshots__*" -name "*.png" -newer TestResults.xcresult -type f 2>/dev/null | while read -r file; do
              echo "Found recently modified: $file"
              cp "$file" snapshot-failures/ 2>/dev/null || true
            done
          fi
          
          # Count what we found
          COUNT=$(ls -1 snapshot-failures/*.png 2>/dev/null | wc -l | tr -d ' ')
          echo "Total snapshot files found: $COUNT"
          
          if [ "$COUNT" -gt "0" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "count=$COUNT" >> $GITHUB_OUTPUT
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¸ Snapshot Failures ($COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download **snapshot-failures** artifact to view diff images" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            ls -1 snapshot-failures/*.png 2>/dev/null | head -15 | while read -r f; do
              echo "- \`$(basename "$f")\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload Snapshot Failures
        if: steps.snapshots.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-failures
          path: snapshot-failures/
          retention-days: 3
          if-no-files-found: ignore
          
      - name: Upload Test Results
        if: steps.find_results.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ${{ steps.find_results.outputs.path }}
          retention-days: 3
          if-no-files-found: ignore
          
      - name: Add Artifact Links
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **test-results** - Full xcresult bundle (open in Xcode)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.snapshots.outputs.found }}" = "true" ]; then
            echo "- **snapshot-failures** - PNG diff images from failed snapshot tests" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Fail if tests failed
        if: steps.tests.outcome == 'failure'
        run: exit 1
